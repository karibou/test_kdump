#cloud-config
{% if do_update %}
# Update apt database on first boot
# (ie run apt-get update)
#
# Default: true
# Aliases: apt_update
package_update: true
{% endif %}
{% if do_upgrade %}
# Upgrade the instance on first boot
# (ie run apt-get upgrade)
#
# Default: false
# Aliases: apt_upgrade
package_upgrade: true
{% endif %}
hostname: test-kdump
manage_etc_hosts: true
{% if use_proxy %}
apt_proxy: http://192.168.0.13:8000
{% endif %}

ssh_import_id: [louis-bouchard]


#apt_sources:
#  - source: "ppa:louis-bouchard/networked-kdump"

write_files:
-   encoding: b64
    content: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBbm9OdmlRWnR2VHZhYnQrMzRRMnlEN255bjgycFVjYTFXZEc5cHl0N1lGdUozWWdLCllzK3NteTF0T24zTEZJRlRjek5ya29KbU91cnhSRDA1ZlN3cFRoZ0hOMnc3YXBPaGZ1dnkrNVNRTGJHc0Vxbk0KazR3c0FybFFSYWNUUmx2ZHovSE0yNHlWTHhCeWMrcVVVc1pEbTVMV2pUM2l0ajBDa1lseHc0ajJwRmdYN1lQYQpGSjkxa3pqd1lteHRlRGdMUmhwcXZnK2svY3BkT0c3RU4vNVNYZjYzRDlXK3pCSGkzdUd0N1BZRXRvbURBdS8xCjhUNW5FaTQyZEtWRUJmOUVOVC92cU1WWVhTK0MvdHNjVkc2SDIvSXdWN1NNUHRYcVhxL1FGbFBFM0ZqUVdWS04KWE5pamovVHcxMGE0S1BtVWo1cDZKaGxlQnNLVkdqUlM1Rk9TcHdJREFRQUJBb0lCQUZXZkdYZ2lpTlJXcUQ2TAppWDkvTGxkZ1ViWVFHUTJiRUFwY1NOMHJsNUVNNFFOUW9JdVBNZVVBUEtnRG10YVFwTXJ0VTRYbitlQ0pWNWxNCm1Pa01HYU9kUndpZzVkZER0MUFma3poaG54K1BnU3J6blJWMSthL2UrWVVtSWpzM0ZERm1vd2xVZnFEVmVYMHoKa0xyRmJXOXplWUVCbEp4cmlCK2s1bGFBZlBsMzRvLzhGbHByWEFhViszczJxRXVXd05NeEhJNGNuRzlURE16RgpmdGFwT2o0c2hCcmoyS2g1Tnc2NjVqVW1aMDRlRTFhTHpjT2Y0d1dST1MyQlhyVkxtbTZ5MWhvNWF5QnErNklvCm1NbXdWSElWTnNROXNRUnBMWitnZnFneWlBNE4rWVpzWHlxcU4xVkdpNStKSyt3MGRlaGY3RzVqUkdSbmo0RDEKclhRa3NjRUNnWUVBekRlanhnYTMzZWFsb0hvTkk2Y3NaVEtleHkzVHl5eDRNSUJUdEdlbEZYU3Z4MDFQZTZBUwpYaTAxNDNhSEFPdkpYdmF1ZVdudjhCNDQ3MVJ2dzZ4cmEzYTNmdTFLVTNrTVRNZ09aTVpQRnlmdEhuanJ1b1JiCndMMTdFVkV5TGljeGt0Smw0RTFPQmh5U0E3SVU0NjdaM0VpbGtCdDV4N0FwV2F3UmY2MHVCbE1DZ1lFQXhyVUUKYkE5SDN3MEFoaHQvdC9QaFJMSDhpWmZOMm9xU0E4S3RIV0VZdWFXaEVrMXVIS3NXZlVvS3YvMnBMczFRcGJpYgpQa2hoR21nSjRmTXVUQTl6YzIxRTVCelp6VGtqTHJhOWV2ZG9TbkhodHlWa0R4aHFMakc4bU1GcmhlME51dXU0ClIwM1cyZHBoVzVuS3RmTVhqQm1zWTdnQzVxUUpDTEIwd2F3NXo5MENnWUVBcmhYRU01d29neTRLQk1ubWgzMEwKMkZ5Vmc1OXFTMmxtTDVwRlFLV1YwYnQ5Mkx6cnc2d0ozR1JYNnNad2dYVitYTWlXcFFPTXVUbGFPWkxXRDR6YwpxV2d6TmkwYnpocURSTFRKcUZod3RZR2duZmhnb3NnUDJ6YnJRVERoUVB6Q1FyRytqTDM1aERZNHRwUEpRT29kCjU2MjZEU1dPNDQ0bFFiN3Z6OUlXU09jQ2dZRUFoZjFLSGhPdnd4aGhZZ3pvOG9IaFJSRS8yUWdrSjFtSlhEL0oKdkNYZEpsSXBhczRMa2dsTUFQQU1qNm5jaTFLbkx4aHNsbkw0QjNaZ001eG5lNkp2bDBYM1RscW1BMXlqL0x2OAp5UTVMcE9kbDdMbXAzd1AzbFc2MFhjMFBWQitsUW9Yd25TUS8zR2NGZjE4VThkd1o1TDdySDlMVklmRTZwa0ZXCmVjSkl1WUVDZ1lCbEI1SEMvaXVnOUJvMnNNNERucWVTd2RCeG5tR2ZjT3Z2T0czL29DcEdNTm0rczFjaCs5Z0kKaDJJU1o4SlYxOWduL2thaGFuR2JhMWYydUF2dlB3Q2lrT05MZkRwV2d3dmRYSXhaVVo4NmNuaENvWTJsWXJvRgpaU2ZhMmloWjNWTWNSZE9qS01JZlo3VDNXc2h0VktiV0ZmdVk2OUZZMmtvM25qUUZhQWVMK2c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
    owner: root:root
    path: /root/.ssh/kdump_id_rsa
    permissions: '0600'
-   encoding: b64
    content: IyEvdXNyL2Jpbi9weXRob24zCmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBzdWJwcm9jZXNzCmltcG9ydCB0aW1lCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgYXB0CmltcG9ydCBhcHQucHJvZ3Jlc3MKCl9FQkFEID0gLTEKX0VPSyA9IDAKX2NyYXNoX2RpciA9ICcvdmFyL2NyYXNoJwpfbmV4dF9waGFzZSA9ICd7fS9uZXh0LXRlc3QnLmZvcm1hdChfY3Jhc2hfZGlyKQpfcmVtb3RlX3NlcnZlciA9ICdrZHVtcC1uZXRjcmFzaCcKX3JlbW90ZV91c2VyID0gJ3VidW50dScKX25mc19yZW1vdGVfbXAgPSAne306L3Zhci9jcmFzaCcuZm9ybWF0KF9yZW1vdGVfc2VydmVyKQpfY29uZmZpbGUgPSAiL2V0Yy9kZWZhdWx0L2tkdW1wLXRvb2xzIgpfZGVmYXVsdHNfZmlsZSA9ICIvZXRjL2RlZmF1bHQva2R1bXAtdGVzdC1zY3JpcHQiCgoKZGVmIGdldF9kZWZhdWx0cygpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbigie30iLmZvcm1hdChfZGVmYXVsdHNfZmlsZSwgJ3InKSkgYXMgZGVmYXVsdHM6CiAgICAgICAgICAgIGZvciBlbnZfdmFyIGluIGRlZmF1bHRzLnJlYWRsaW5lcygpOgogICAgICAgICAgICAgICAgdmFyID0gZW52X3Zhci5wYXJ0aXRpb24oJz0nKVswXQogICAgICAgICAgICAgICAgdmFsID0gInt9Ii5mb3JtYXQoZW52X3Zhci5wYXJ0aXRpb24oJz0nKVsKICAgICAgICAgICAgICAgICAgICBsZW4oZW52X3Zhci5wYXJ0aXRpb24oJz0nKSktMV0pLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCB2YXIuc3RhcnRzd2l0aCgiIyIpIGFuZCB2YWwgIT0gJzAnOgogICAgICAgICAgICAgICAgICAgIG9zLmVudmlyb24uc2V0ZGVmYXVsdCgne30nLmZvcm1hdCh2YXIpLCAne30nLmZvcm1hdCh2YWwpKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwYXNzCgoKY2xhc3MgUGhhc2Uob2JqZWN0KToKICAgICIiIlRoZSBwaGFzZSBvZiB0aGUgdGVzdCB0byBleGVjdXRlIiIiCiAgICBkZWYgX19pbml0X18oc2VsZiwgcGhhc2UpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZiA9IG9wZW4oJ3t9Jy5mb3JtYXQoX25leHRfcGhhc2UpLCAncicpCiAgICAgICAgICAgIHNlbGYucGhhc2UgPSBmLnJlYWQoKS5zdHJpcCgpCiAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgZiA9IG9wZW4oJ3t9Jy5mb3JtYXQoX25leHRfcGhhc2UpLCAndycpCiAgICAgICAgICAgIGYud3JpdGUoInt9XG4iLmZvcm1hdChwaGFzZSkpCiAgICAgICAgICAgIGYuY2xvc2UoKQogICAgICAgICAgICBvcy5zeW5jKCkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBzZWxmLnBoYXNlID0gcGhhc2UKCiAgICBkZWYgY3VycmVudChzZWxmKToKICAgICAgICBmID0gb3Blbigne30nLmZvcm1hdChfbmV4dF9waGFzZSksICdyJykKICAgICAgICBzZWxmLnBoYXNlID0gZi5yZWFkKCkuc3RyaXAoKQogICAgICAgIGYuY2xvc2UoKQogICAgICAgIHJldHVybiBzZWxmLnBoYXNlCgogICAgZGVmIG5leHQoc2VsZiwgcGhhc2UpOgogICAgICAgIGYgPSBvcGVuKCd7fScuZm9ybWF0KF9uZXh0X3BoYXNlKSwgJ3cnKQogICAgICAgIGYud3JpdGUoInt9XG4iLmZvcm1hdChwaGFzZSkpCiAgICAgICAgZi5jbG9zZSgpCiAgICAgICAgb3Muc3luYygpCiAgICAgICAgc2VsZi5waGFzZSA9IHBoYXNlCiAgICAgICAgcmV0dXJuIHNlbGYucGhhc2UKCiAgICBkZWYga2lsbChzZWxmKToKICAgICAgICBvcy51bmxpbmsoJ3t9Jy5mb3JtYXQoX25leHRfcGhhc2UpKQoKICAgIGRlZiBzZXRfY29uZmZpbGUoc2VsZik6CiAgICAgICAgd2l0aCBvcGVuKCJ7fS5yZWYiLmZvcm1hdChfY29uZmZpbGUpLCAiciIpIGFzIG9yaWc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYucGhhc2UgPT0gJ2xvY2FsJyBvciBzZWxmLnBoYXNlID09ICdsb2NhbC1vbmx5JzoKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oInt9Ii5mb3JtYXQoX2NvbmZmaWxlKSwgInciKSBhcyBuZXdfY29uZjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gb3JpZy5yZWFkbGluZXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuZmluZCgnVVNFX0tEVU1QJykgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29uZi53cml0ZSgie30iLmZvcm1hdCgnVVNFX0tEVU1QPTFcbicpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdfY29uZi53cml0ZSgie30iLmZvcm1hdChsaW5lKSkKICAgICAgICAgICAgICAgIGVsaWYgc2VsZi5waGFzZSA9PSAnc3NoJzoKICAgICAgICAgICAgICAgICAgICByZWYgPSBvcmlnLnJlYWQoKQogICAgICAgICAgICAgICAgICAgIG9yaWcuc2VlaygwKQogICAgICAgICAgICAgICAgICAgIGlmIHJlZi5maW5kKCJTU0giKSAhPSAtMToKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKCJ7fSIuZm9ybWF0KF9jb25mZmlsZSksICJ3IikgYXMgbmV3X2NvbmY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBvcmlnLnJlYWRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuZmluZCgnVVNFX0tEVU1QJykgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbmYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAie30iLmZvcm1hdCgnVVNFX0tEVU1QPTFcbicpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb25mLndyaXRlKCJ7fSIuZm9ybWF0KGxpbmUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbmYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1NTSD0ie30iXG4nLmZvcm1hdChfc3NoX3JlbW90ZV9zZXJ2ZXIpKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KCJTU0ggZnVuY3Rpb25hbGl0eSBub3QgZm91bmQgaW4ge30iLmZvcm1hdCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7fScuZm9ybWF0KF9jb25mZmlsZSkpKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX0VCQUQKICAgICAgICAgICAgICAgIGVsaWYgc2VsZi5waGFzZSA9PSAnbmZzJzoKICAgICAgICAgICAgICAgICAgICByZWYgPSBvcmlnLnJlYWQoKQogICAgICAgICAgICAgICAgICAgIG9yaWcuc2VlaygwKQogICAgICAgICAgICAgICAgICAgIGlmIHJlZi5maW5kKCJORlMiKSAhPSAtMToKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKCJ7fSIuZm9ybWF0KF9jb25mZmlsZSksICJ3IikgYXMgbmV3X2NvbmY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBvcmlnLnJlYWRsaW5lcygpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuZmluZCgnVVNFX0tEVU1QJykgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbmYud3JpdGUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAie30iLmZvcm1hdCgnVVNFX0tEVU1QPTFcbicpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld19jb25mLndyaXRlKCJ7fSIuZm9ybWF0KGxpbmUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbmYud3JpdGUoJ05GUz0ie30iXG4nLmZvcm1hdChfbmZzX3JlbW90ZV9tcCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEFkZGluZyBIT1NUVEFHIHRvIHRlc3QgdGhlIGZ1bmN0aW9uYWxpdHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQW5kIGF2b2lkIG5hbWUgY29sbGlzaW9uIGIvdyBTU0ggYW5kIE5GUwogICAgICAgICAgICAgICAgICAgICAgICAgICAgIwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2NvbmYud3JpdGUoJ0hPU1RUQUc9Imhvc3RuYW1lIlxuJykKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiTkZTIGZ1bmN0aW9uYWxpdHkgbm90IGZvdW5kIGluIHt9Ii5mb3JtYXQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne30nLmZvcm1hdChfY29uZmZpbGUpKSkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9FQkFECiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFR5cGVFcnJvcigiSW52YWxpZCB0ZXN0IikKICAgICAgICAgICAgZXhjZXB0IFBlcm1pc3Npb25FcnJvciBhcyBlcnI6CiAgICAgICAgICAgICAgICBwcmludCgoIlVzZXIgZG9lcyBub3QgaGF2ZSB0aGUgcHJpdmlsZWdlICIKICAgICAgICAgICAgICAgICAgICAgICAidG8gY2hhbmdlIHRoaXMgZmlsZVx0e30iKS5mb3JtYXQoZXJyKSkKICAgICAgICAgICAgICAgIHJldHVybiBfRUJBRAogICAgICAgIHJldHVybgoKCmRlZiB0cmlnZ2VyX2NyYXNoKCk6CiAgICBpZiBjcmFzaF9zd2l0Y2g6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmID0gb3BlbigiL3Byb2Mvc3lzcnEtdHJpZ2dlciIsICJhIikKICAgICAgICAgICAgZi53cml0ZSgnYycpCiAgICAgICAgZXhjZXB0IFBlcm1pc3Npb25FcnJvciBhcyBlcnI6CiAgICAgICAgICAgIHByaW50KCJNdXN0IGJlIHJvb3QgdG8gdHJpZ2dlciBhIGNyYXNoIGR1bXBcdHt9Ii5mb3JtYXQoZXJyKSkKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIldvdWxkIHRyaWdnZXIgYSBwYW5pYyBidXQgY3Jhc2hfc3dpdGNoIGlzIEZhbHNlIikKCgpkZWYgY3JlYXRlX3JlZl9jb25mKCk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJ7fS5yZWYiLmZvcm1hdChfY29uZmZpbGUpLCAiciIpIGFzIGY6CiAgICAgICAgICAgIHBhc3MKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9zLnJlbmFtZSgKICAgICAgICAgICAgICAgICJ7fSIuZm9ybWF0KF9jb25mZmlsZSksCiAgICAgICAgICAgICAgICAie30ucmVmIi5mb3JtYXQoX2NvbmZmaWxlKSkKICAgICAgICBleGNlcHQgUGVybWlzc2lvbkVycm9yIGFzIGVycjoKICAgICAgICAgICAgcHJpbnQoKCJVc2VyIGRvZXMgbm90IGhhdmUgdGhlIHByaXZpbGVnZSAiCiAgICAgICAgICAgICAgICAgICAidG8gY2hhbmdlIHRoaXMgZmlsZVx0e30iKS5mb3JtYXQoZXJyKSkKICAgICAgICAgICAgcmV0dXJuIF9FQkFECiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludCgiVW5hYmxlIHRvIGZpbmQge30iLmZvcm1hdChfY29uZmZpbGUpKQogICAgICAgICAgICByZXR1cm4gX0VCQUQKICAgIHJldHVybgoKCmRlZiBydW5fdGVzdCh0ZXN0KToKICAgIGlmIHRlc3QgPT0gJ2xvY2FsJyBvciB0ZXN0ID09ICdsb2NhbC1vbmx5JzoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvYWQgPSBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChbImtkdW1wLWNvbmZpZyIsICJsb2FkIl0pCiAgICAgICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yOgogICAgICAgICAgICBwcmludCgiVW5hYmxlIHRvIGxvYWQga2R1bXAgbW9kdWxlIikKICAgICAgICAgICAgcmV0dXJuIF9FQkFECiAgICAgICAgaWYgdGVzdCA9PSAnbG9jYWwtb25seSc6CiAgICAgICAgICAgIGFjdGlvbi5uZXh0KCdjb21wbGV0ZWQnKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFjdGlvbi5uZXh0KCdzc2gnKQogICAgZWxpZiB0ZXN0ID09ICdzc2gnOgogICAgICAgIGFjdGlvbi5uZXh0KCduZnMnKQogICAgZWxpZiB0ZXN0ID09ICduZnMnOgogICAgICAgIGFjdGlvbi5uZXh0KCdjb21wbGV0ZWQnKQogICAgZWxzZToKICAgICAgICByYWlzZSBUeXBlRXJyb3IoIkludmFsaWQgdGVzdCIpCiAgICB0cmlnZ2VyX2NyYXNoKCkKICAgIHJldHVybgoKCmRlZiBnYXRoZXJfdGVzdF9yZXN1bHRzKCk6CiAgICBpZiBub3QgX2xvY2FsX29ubHk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX291dHB1dCgKICAgICAgICAgICAgICAgIFsibW91bnQiLCAia2R1bXAtbmV0Y3Jhc2g6L3Zhci9jcmFzaCIsICIvbW50Il0pCiAgICAgICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yOgogICAgICAgICAgICBwcmludCgiVW5hYmxlIHRvIG1vdW50IHJlbW90ZSBzZXJ2ZXIgdG8gY29sbGVjdCByZXN1bHRzIikKICAgICAgICAgICAgcmV0dXJuIF9FQkFECiAgICBub3cgPSB0aW1lLmxvY2FsdGltZSh0aW1lLnRpbWUoKSkKICAgIGZvciBwYXRoLCBkaXJzLCBmaWxlcyBpbiBvcy53YWxrKF9jcmFzaF9kaXIpOgogICAgICAgIGlmIGRpcnMgYW5kIGRpcnNbMF0uZmluZChzdHIobm93LnRtX3llYXIpKSA9PSAwOgogICAgICAgICAgICBvcy5yZW5hbWUoCiAgICAgICAgICAgICAgICAie30ve30iLmZvcm1hdChwYXRoLCBkaXJzWzBdKSwKICAgICAgICAgICAgICAgICJ7fS9sb2NhbF97fSIuZm9ybWF0KHBhdGgsIGRpcnNbMF0pKQogICAgaWYgbm90IF9sb2NhbF9vbmx5OgogICAgICAgIGhvc3QgPSBwbGF0Zm9ybS5ub2RlKCkKICAgICAgICBmb3IgcGF0aCwgZGlycywgZmlsZXMgaW4gb3Mud2FsaygnL21udCcpOgogICAgICAgICAgICBmb3IgZGlyIGluIGRpcnM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgZGlyLnN0YXJ0c3dpdGgoaG9zdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNwID0gc3VicHJvY2Vzcy5jaGVja19vdXRwdXQoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgImNwIiwgIi1wciIsICJ7fS97fSIuZm9ybWF0KHBhdGgsIGRpciksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAie30vbmZzX3t9Ii5mb3JtYXQoX2NyYXNoX2RpciwgZGlyKV0pCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgY3AgPSBzdWJwcm9jZXNzLmNoZWNrX291dHB1dChbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY3AiLCAiLXByIiwgInt9L3t9Ii5mb3JtYXQocGF0aCwgZGlyKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ7fS9zc2hfe30iLmZvcm1hdChfY3Jhc2hfZGlyLCBkaXIpXSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvcjoKICAgICAgICAgICAgICAgICAgICBwcmludCgiVW5hYmxlIHRvIGNvcHkgZmlsZXMgZnJvbSByZW1vdGUgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX0VCQUQKCiAgICBpZiBub3QgX2xvY2FsX29ubHk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtb3VudCA9IHN1YnByb2Nlc3MuY2hlY2tfb3V0cHV0KFsidW1vdW50IiwgIi9tbnQiXSkKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3I6CiAgICAgICAgICAgIHByaW50KCJVbmFibGUgdG8gdW5tb3VudCAvbW50IikKICAgICAgICAgICAgcmV0dXJuIF9FQkFECgoKZGVmIGNyYXNoX2NoZWNrKGtlcm5lbCwgY29yZSk6CiAgICBwcmludCgicnVubmluZyBjcmFzaCAtc3Qge30ge30iLmZvcm1hdChrZXJuZWwsIGNvcmUpKQogICAgdHJ5OgogICAgICAgIHN1YnByb2Nlc3MuY2hlY2tfb3V0cHV0KFsiY3Jhc2giLCAiLXN0Iiwga2VybmVsLCBjb3JlXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5ERVZOVUxMKQogICAgICAgIHByaW50KCJjcmFzaCB0ZXN0IHN1Y2NlZWRlZCBmb3Ige30iLmZvcm1hdChjb3JlKSkKICAgICAgICByZXR1cm4gX0VPSwogICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yIGFzIGNyYXNoX2Vycm9yOgogICAgICAgIHByaW50KCJjcmFzaCB0ZXN0IGZhaWxlZCBmb3Ige30iLmZvcm1hdChjb3JlKSkKICAgICAgICBwcmludCgiRXJyb3IgT3V0cHV0XG57fSIuZm9ybWF0KGNyYXNoX2Vycm9yLm91dHB1dC5kZWNvZGUoIlVURi04IikpKQogICAgICAgIHJldHVybiBfRUJBRAoKCmRlZiBhbmFseXNlX3Jlc3VsdHMoKToKICAgIGlmIF9ub19yZXN1bHQ6CiAgICAgICAgcHJpbnQoIlJlc3VsdCBBbmFseXNpcyBvdmVycmlkZW4gYnkgTk9fUkVTVUxUIikKICAgICAgICByZXR1cm4KICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIlJ1bm5pbmcgcmVzdWx0IGFuYWx5c2lzIikKICAgICAgICAjCiAgICAgICAgIyBGaXJzdCB3ZSBnZXQgdGhlIGRiZ3N5bSBwYWNrYWdlCiAgICAgICAgIwogICAgICAgIHdpdGggb3BlbigiL2V0Yy9hcHQvc291cmNlcy5saXN0LmQvZGRlYnMubGlzdCIsICJ3IikgYXMgZGRlYnM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJlbGVhc2UgPSBwbGF0Zm9ybS5kaXN0KClbMl0KICAgICAgICAgICAgICAgIGZvciBhcmNoaXZlIGluICcnLCAnLXNlY3VyaXR5JywgJy11cGRhdGVzJywgJy1wcm9wb3NlZCc6CiAgICAgICAgICAgICAgICAgICAgZGRlYnMud3JpdGUoKCJkZWIgaHR0cDovL2RkZWJzLnVidW50dS5jb20vIHt9ezoxMH0iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtYWluIHJlc3RyaWN0ZWQgdW5pdmVyc2UgbXVsdGl2ZXJzZVxuIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZm9ybWF0KHJlbGVhc2UsIGFyY2hpdmUpKSkKICAgICAgICAgICAgICAgIGRkZWJzLmNsb3NlKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoIlVuYWJsZSB0byBjcmVhdGUgL2V0Yy9hcHQvc291cmNlcy5saXN0LmQvZGRlYnMubGlzdCIpCiAgICAgICAgICAgICAgICByZXR1cm4gX0VCQUQKICAgICAgICBwcmludCgiVXBkYXRpbmcgQVBUIGNhY2hlIHdpdGggbmV3IHNvdXJjZXMiKQogICAgICAgIGNhY2hlID0gYXB0LkNhY2hlKCkKICAgICAgICBrZXJuX3ZlcnMgPSBwbGF0Zm9ybS5yZWxlYXNlKCkKICAgICAgICBjYWNoZS51cGRhdGUoKQogICAgICAgIGNhY2hlLm9wZW4oKQogICAgICAgIHRyeToKICAgICAgICAgICAgcGtnID0gY2FjaGVbJ2xpbnV4LWltYWdlLXt9LWRiZ3N5bScuZm9ybWF0KGtlcm5fdmVycyldCiAgICAgICAgICAgIGlmIG5vdCBwa2cuaXNfaW5zdGFsbGVkOgogICAgICAgICAgICAgICAgcGtnLm1hcmtfaW5zdGFsbCgpCiAgICAgICAgICAgICAgICBwcmludCgiSW5zdGFsbGluZyBsaW51eC1pbWFnZS17fS1kYmdzeW0iLmZvcm1hdChrZXJuX3ZlcnMpKQogICAgICAgICAgICAgICAgY2FjaGUuY29tbWl0KCkKICAgICAgICBleGNlcHQgS2V5RXJyb3I6CiAgICAgICAgICAgIHByaW50KCJVbmFibGUgdG8gZmluZCBsaW51eC1pbWFnZS17fS1kYmdzeW0iLmZvcm1hdChrZXJuX3ZlcnMpKQogICAgICAgICAgICByZXR1cm4gX0VCQUQKCiAgICAgICAgbmFtZWxpc3QgPSAnL3Vzci9saWIvZGVidWcvYm9vdC92bWxpbnV4LXt9Jy5mb3JtYXQoa2Vybl92ZXJzKQoKICAgICAgICBlcnJvciA9IDAKICAgICAgICBmb3IgcGF0aCwgZGlycywgZmlsZXMgaW4gb3Mud2FsayhfY3Jhc2hfZGlyKToKICAgICAgICAgICAgaWYgbm90IGRpcnM6CiAgICAgICAgICAgICAgICBkdW1wZmlsZSA9IFtkdW1wZmlsZSBmb3IgZHVtcGZpbGUgaW4gZmlsZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICdkdW1wJyBpbiBkdW1wZmlsZV1bMF0KICAgICAgICAgICAgICAgIGVycm9yID0gZXJyb3IgfCBjcmFzaF9jaGVjayhuYW1lbGlzdCwgJ3t9L3t9Jy4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQocGF0aCwgZHVtcGZpbGUpKQogICAgICAgIHJldHVybiBlcnJvcgoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgICMgRmlyc3QgZ2V0IHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZQogICAgIyBpZiB0aGV5IGFyZSBkZWZpbmVkIGluIC9ldGMvZGVmYXVsdC90ZXN0LWtkdW1wLXNjcmlwdAogICAgIwogICAgZ2V0X2RlZmF1bHRzKCkKCiAgICAjIElmIG5vdCwgdGhleSBjYW4gc3RpbGwgYmUgZGVmaW5lZCBpbiB0aGUgZW52aXJvbm1lbnQuCiAgICAjIERlZmluZSBMT0NBTF9PTkxZID0gMSBhcyBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZQogICAgIyB0byBpbmRpY2F0ZSB0aGF0IG5ldGR1bXAgdGVzdHMgc2hvdWxkIG5vdCBiZSBydW4gKFNTSCAmIE5GUykKICAgICMKICAgICMgTk9fUkVTVUxUID0gMSB3aWxsIG92ZXJyaWRlIHRoZSBhbmFseXNpcyBvZiB0aGUgcmVzdWx0cwogICAgIyB3aGljaCBjYW4gYmUgdGltZSBjb25zdW1pbmcKICAgIF9sb2NhbF9vbmx5ID0gYm9vbChvcy5lbnZpcm9uLmdldCgnTE9DQUxfT05MWScsIEZhbHNlKSkKICAgIF9ub19yZXN1bHQgPSBib29sKG9zLmVudmlyb24uZ2V0KCdOT19SRVNVTFQnLCBGYWxzZSkpCiAgICB1c2VyID0gb3MuZW52aXJvbi5nZXQoJ1JFTU9URV9VU0VSJykKICAgIGlmIHVzZXI6CiAgICAgICAgX3JlbW90ZV91c2VyID0gdXNlcgogICAgX3NzaF9yZW1vdGVfc2VydmVyID0gJ3t9QHt9Jy5mb3JtYXQoX3JlbW90ZV91c2VyLCBfcmVtb3RlX3NlcnZlcikKCiAgICBpZiBsZW4oc3lzLmFyZ3YpID4gMToKICAgICAgICBjcmFzaF9zd2l0Y2ggPSBUcnVlCiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICBjcmFzaF9zd2l0Y2ggPSBGYWxzZQoKICAgIGlmIGNyZWF0ZV9yZWZfY29uZigpID09IF9FQkFEOgogICAgICAgIGV4aXQoX0VCQUQpCgogICAgaWYgX2xvY2FsX29ubHk6CiAgICAgICAgYWN0aW9uID0gUGhhc2UoJ2xvY2FsLW9ubHknKQogICAgZWxzZToKICAgICAgICBhY3Rpb24gPSBQaGFzZSgnbG9jYWwnKQoKICAgIHByaW50KCJSdW5uaW5nIHBoYXNlIHt9Ii5mb3JtYXQoYWN0aW9uLmN1cnJlbnQoKSkpCiAgICBpZiBhY3Rpb24ucGhhc2UgIT0gJ2NvbXBsZXRlZCc6CiAgICAgICAgaWYgYWN0aW9uLnNldF9jb25mZmlsZSgpICE9IF9FQkFEOgogICAgICAgICAgICBydW5fdGVzdChhY3Rpb24ucGhhc2UpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIlVuYWJsZSB0byBjb250aW51ZSB3aXRoIHRlc3RzIikKICAgICAgICAgICAgYWN0aW9uLm5leHQoJ2NvbXBsZXRlZCcpCiAgICAgICAgICAgIHN5cy5leGl0KF9FQkFEKQogICAgZWxzZToKICAgICAgICBhY3Rpb24ua2lsbCgpCiAgICAgICAgcmV0ID0gZ2F0aGVyX3Rlc3RfcmVzdWx0cygpCiAgICAgICAgaWYgbm90IHJldDoKICAgICAgICAgICAgcmV0ID0gYW5hbHlzZV9yZXN1bHRzKCkKICAgICAgICAgICAgaWYgbm90IHJldDoKICAgICAgICAgICAgICAgIHByaW50KCJBbGwgdGVzdCBzdWNjZWVkZWQiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoIkZhaWx1cmUgZHVyaW5nIGFuYWx5c2lzIG9mIHRoZSByZXN1bHRzIikKICAgICAgICBzeXMuZXhpdChyZXQpCgojIHZpbTogZXQgdHM9NCBzdz00Cg==
    owner: root:root
    path: /etc/init.d/kdump-test-script.py
    permissions: '0750'

packages:
 - nfs-kernel-server
 - makedumpfile
 - kdump-tools
 - crash

runcmd:
{% if distrib[0] == 'debian' %}
# Debian specific commands.
# Needed to avoid kexec reboot on Debian
 - touch /tmp/no-kexec-reboot
 - [ sed, -i, 's/115200/115200 crashkernel=128M/', /etc/default/grub ]
{% elif distrib[0] == 'ubuntu' %}
# Ubuntu specific commands.
 - [ sed, -i, 's/crashkernel=384M-2G:64M/crashkernel=384M-2G:128M/', /etc/grub.d/10_linux ]
{% endif %}
# Test specific toggles
{% if networked == false %}
 - echo "LOCAL_ONLY=1" > /etc/default/kdump-test-script
{% endif %}
{% if results == false %}
 - echo "NO_RESULT=1" >> /etc/default/kdump-test-script
{% endif %}
{% if distrib[0] == 'debian' %}
 - echo "REMOTE_USER=root" >> /etc/default/kdump-test-script
{% endif %}
#
 - echo "StrictHostKeyChecking no" > /root/.ssh/config
 - ln -s /etc/init.d/kdump-test-script.py /etc/rc2.d/S99kdump-test-script.py

power_state:
 delay: now
 mode: reboot
 message: Rebooting after crashdump setup
